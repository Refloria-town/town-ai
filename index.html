<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>RefloriaTownAI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
  <style>
    body {
      margin: 0; background: #222;
      color: #eee; font-family: 'Segoe UI', 'Meiryo', sans-serif;
      min-height: 100vh;
    }
    .container {
      display: flex;
      height: 100vh;
    }
    .sidebar {
      background: #181818;
      width: 250px; min-width:180px; max-width:400px;
      padding: 1em;
      box-sizing: border-box;
      border-right:1px solid #333;
      display: flex; flex-direction: column;
    }
    .sidebar h2 {
      margin-top:0; font-size:1.2em; color:#aaf;
      margin-bottom:0.4em;
    }
    .file-list {
      flex:1; overflow-y:auto; margin-bottom:1em;
      font-size: 0.98em;
    }
    .file-list ul { padding-left: 1em; }
    .file-list li {
      padding: 0.2em 0.6em;
      cursor: pointer; border-radius:6px;
      transition: background 0.1s;
    }
    .file-list li:hover { background: #333; }
    .info {
      font-size:0.85em; color:#88c;
      border-top:1px solid #333; padding-top:0.5em;
    }
    .main {
      flex:1;
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    header {
      padding:1em 1.2em 0.7em 1.2em;
      font-size:1.4em; font-weight:bold;
      border-bottom:1.5px solid #292929;
      background: #24262c;
      letter-spacing:1px; color: #aef;
      text-shadow:0 0 2px #337, 0 1px 8px #113;
      box-shadow: 0 2px 12px #001c 1px;
    }
    #chat {
      flex:1;
      background: #202028;
      overflow-y: auto;
      padding:1.2em;
      display: flex; flex-direction: column;
      gap:10px;
    }
    .bubble {
      display: flex; flex-direction: row;
      align-items:flex-end;
      max-width:80%;
      margin-bottom:3px;
      animation: fadeIn 0.2s;
    }
    .bubble.user { flex-direction: row-reverse; align-self: flex-end;}
    .bubble .avatar {
      width:36px; height:36px;
      border-radius:50%;
      background:#444;
      margin: 0 7px;
    }
    .bubble.user .avatar { background:#2e5add;}
    .bubble.ai .avatar { background:#00594e;}
    .bubble .msg {
      padding:0.75em 1em; border-radius: 1.1em;
      background: #333d;
      box-shadow: 0 2px 10px #0004;
      font-size: 1.06em;
      white-space: pre-wrap;
      word-break: break-word;
      color:#eef;
      position:relative;
      min-width:36px;
      transition: background 0.2s;
    }
    .bubble.ai .msg { background: #113d42; color:#bff;}
    .bubble.user .msg { background:#293e7a; color: #ecf3fd;}
    .bubble .ts {
      font-size: 0.65em; color: #ccd9;
      margin: 0 0.2em 0 0.2em;
    }
    form.input-bar {
      display: flex; align-items: center;
      background: #23242e; padding: 0.7em 1em;
      border-top:1.5px solid #444;
      gap:0.7em;
    }
    .input-bar input[type="text"] {
      flex:1; padding:0.7em 1em;
      font-size:1.1em;
      background:#343a4a; color: #eff;
      border:none; border-radius:8px;
      outline:none;
      margin-right:0.2em;
      transition: background 0.15s;
    }
    .input-bar input[type="text"]:focus {
      background:#465398;
    }
    .input-bar button, .input-bar label {
      background: #101e3a;
      color: #b4f;
      border:none;
      border-radius:8px;
      padding: 0.6em 1em;
      cursor:pointer;
      font-size: 1em;
      margin-left: 0.2em;
      transition: background 0.15s, color 0.17s;
    }
    .input-bar .file-btn {
      background: #023732;
      color:#bff; font-size:1.2em;
    }
    .input-bar button:hover, .input-bar label:hover {
      background:#116ad6; color:#fff;
    }
    @media (max-width: 700px) {
      .container { flex-direction: column;}
      .sidebar { width:auto; border-right:none; border-bottom:1px solid #333;}
      .main { min-height:60vh;}
      header{font-size:1.1em; padding:0.7em 0.8em;}
      #chat{ padding:0.7em;}
    }
    @keyframes fadeIn { from{ opacity:0; translate:0 50px;} }
    .file-preview {
      margin-top:0.7em; max-width:95%; border-radius:8px;
      background:#171a;
      padding:12px;
    }
    .file-preview img {
      display:block; margin:auto;
      max-height:220px; max-width:95%; border-radius:10px;
      box-shadow:0 0 12px #236a88a0;
    }
    .file-preview pre {
      background:#223e; color:#cff; border-radius:8px;
      overflow-x:auto; padding:12px; font-size:1em;
    }
    .loading { animation: blink 1s infinite alternate;}
    @keyframes blink{ 0%{opacity:1;} 100%{opacity:0.4;} }
  </style>
</head>
<body>
<div class="container">
  <aside class="sidebar">
    <h2>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h2>
    <div class="file-list" id="fileList"><span>èª­ã¿è¾¼ã¿ä¸­...</span></div>
    <div class="info">
      <b>RefloriaTownAI</b> <br>
      ãƒ»all_files.txtã®å†…å®¹å‚ç…§å¯<br>
      ãƒ»ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¯AIèªè­˜å¯¾å¿œ <br>
      ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã¯ç›´æ¥å‚ç…§<br>
    </div>
  </aside>
  <main class="main">
    <header>
      RefloriaTownAI <span style="font-size:0.66em;color:#fff5;">(Beta)</span>
    </header>
    <div id="chat"></div>
    <form class="input-bar" id="inputBar" autocomplete="off">
      <input type="text" id="userInput" placeholder="è³ªå•ãƒ»ç›¸è«‡ã‚’ã©ã†ãã€‚ç”»åƒ/ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚é€ä¿¡å¯" autocomplete="off"/>
      <label class="file-btn" for="fileInput">ğŸ“</label>
      <input type="file" id="fileInput" accept=".txt,.jpg,.jpeg,.png,.bmp,.gif,.pdf" style="display:none;">
      <button type="submit">é€ä¿¡</button>
    </form>
  </main>
</div>
<script>
  // ãƒãƒ£ãƒƒãƒˆè¡¨ç¤º
  const chat = document.getElementById('chat');
  function appendBubble(msg, sender="ai", previewHtml=null) {
    const div = document.createElement('div');
    div.className='bubble '+sender;
    div.innerHTML=`
      <div class="avatar"></div>
      <div>
        <div class="msg">${msg}</div>
        <span class="ts">${new Date().toLocaleTimeString("ja-JP",{hour12:false})}</span>
        ${previewHtml ? `<div class="file-preview">${previewHtml}</div>` : ''}
      </div>
    `;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  // åˆæœŸã‚ã„ã•ã¤
  appendBubble("ã“ã‚“ã«ã¡ã¯ï¼Refloria Town éå…¬å¼AIã§ã™ã€‚<br>è³ªå•ã‚„ç”»åƒã®è§£æã€å„ç¨®ãƒ•ã‚¡ã‚¤ãƒ«å‚ç…§ãªã©ã”åˆ©ç”¨ãã ã•ã„ã€‚", "ai");

  // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«è¡¨ç¤º
  let allFiles = [];
  async function loadFileList(){
    const el = document.getElementById('fileList');
    try {
      const txt = await fetch('files/all_files.txt').then(r=>r.text());
      allFiles = txt.trim().split('\n').map(f=>f.trim()).filter(f=>f);
      el.innerHTML = "<ul>"+allFiles.map(file=>`<li onclick="showFilePreview('${file.replaceAll("'","\\'")}')">${file}</li>`).join("")+"</ul>";
    } catch(e){
      el.innerHTML = "<span style='color:#f66'>ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§èª­ã¿è¾¼ã¿å¤±æ•—</span>";
    }
  }
  loadFileList();

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªãƒƒã‚¯: å†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  window.showFilePreview = async function(fname){
    let ext = fname.split('.').pop().toLowerCase();
    let preview = '';
    if(ext == 'txt'){
      try{
        let txt = await fetch('files/'+fname).then(r=>r.text());
        preview = `<pre>${escapeHtml(txt.slice(0,2000))}${txt.length>2000?"\n..." : ""}</pre>`;
        appendBubble(fname+" ã®å†…å®¹ã§ã™â†“", "ai", preview);
      }catch{ appendBubble(`${fname} ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`, "ai"); }
    } else if(['jpg','jpeg','png','bmp','gif'].includes(ext)){
      preview = `<img src="files/${encodeURIComponent(fname)}" alt="${fname}">`;
      appendBubble(fname+" ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã™", "ai", preview);
    } else {
      appendBubble(fname+" ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (å¯¾å¿œå½¢å¼: txt, ç”»åƒ)", "ai");
    }
  }
  function escapeHtml(str) {
    return str.replace(/[&<>"]/g, function(tag) {
      const chars = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'};
      return chars[tag]||tag;
    });
  }

  // ç”»åƒèªè­˜: ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰
  let mobilenetModel = null;
  mobilenet.load().then(model=>{mobilenetModel=model;});
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›
  document.getElementById('inputBar').onsubmit = async function(e){
    e.preventDefault();
    const userInput = document.getElementById('userInput');
    let txt = userInput.value.trim();
    if(!txt) return;
    appendBubble(txt, "user");
    userInput.value="";
    await aiResponse(txt);
  }

  async function aiResponse(txt){
    // ç°¡æ˜“å‡¦ç†: ãƒ•ã‚¡ã‚¤ãƒ«åã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ä¸€è‡´
    if(txt.match(/ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰/)&&allFiles.includes("ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ä¸€è¦§.txt")){
      let content = await fetch('files/ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ä¸€è¦§.txt').then(r=>r.text()).catch(()=>null);
      if(content)
        appendBubble("ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ä¸€è¦§.txtã®å†…å®¹ã§ã™â†“", "ai", `<pre>${escapeHtml(content.slice(0,2000))}</pre>`);
      else
        appendBubble("ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ä¸€è¦§.txtã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", "ai");
      return;
    }
    if(txt.match(/è·æ¥­/)&&allFiles.find(f=>f.match(/è·æ¥­ä¸€è¦§/))){
      let target = allFiles.find(f=>f.match(/è·æ¥­ä¸€è¦§/));
      appendBubble(`${target}ã®ç”»åƒã§ã™ã€‚`, "ai", `<img src="files/${encodeURIComponent(target)}">`);
      return;
    }
    if(txt.match(/(ç”»åƒ|ãƒã‚°|èªè­˜|ã‚¹ã‚¯ãƒªãƒ¼ãƒ³|ã‚¨ãƒ©ãƒ¼|ãƒã‚°ç”»é¢)/)){
      appendBubble('ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ ğŸ“·', 'ai');
      document.getElementById('fileInput').click();
      return;
    }
    appendBubble("ã”è³ªå•ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br>ç¾åœ¨ã¯ãƒ•ã‚¡ã‚¤ãƒ«å‚ç…§ãƒ»ç°¡å˜ãªç”»åƒè§£æã€FAQã«ä¸»ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚<br>ã‚ˆã‚Šé«˜åº¦ãªAIç›¸è«‡ã‚„ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹æŠ½å‡ºã®ã”å¸Œæœ›ãŒã‚ã‚Œã°é †æ¬¡æ‹¡å¼µäºˆå®šã§ã™ã€‚","ai");
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ: ãƒ†ã‚­ã‚¹ãƒˆã‚„ç”»åƒã«å¯¾å¿œ
  document.getElementById('fileInput').onchange = function(e){
    if(this.files && this.files[0]) handleFile(this.files[0]);
    this.value='';
  };
  // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
  document.getElementById('userInput').ondrop = (e)=>{
    e.preventDefault();
    if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
  };
  document.getElementById('userInput').ondragover = e=>e.preventDefault();

  async function handleFile(file){
    let ext = file.name.split('.').pop().toLowerCase();
    if(['txt','md','csv','json'].includes(ext)){
      let txt = await file.text();
      appendBubble(`${file.name} ã®å†…å®¹ã§ã™â†“`, "user", `<pre>${escapeHtml(txt.slice(0,2000))}${txt.length>2000?"...":""}</pre>`);
    }else if(['jpg','jpeg','png','bmp','gif'].includes(ext)){
      let reader = new FileReader();
      reader.onload = async (ev)=>{
        let imgHtml = `<img src="${ev.target.result}" alt="${file.name}">`;
        appendBubble(`ç”»åƒã‚’å—ä¿¡ã—ã¾ã—ãŸã€‚\nAIèªè­˜ä¸­...`, "user", imgHtml);
        if(mobilenetModel){
          let img = new window.Image();
          img.src = ev.target.result;
          img.onload = async()=>{
            let res = await mobilenetModel.classify(img);
            let msg = "ç”»åƒèªè­˜çµæœ<br>";
            if(res && res.length){
              msg += res.map(r=>`${r.className} ï¼šç¢ºä¿¡åº¦ ${(r.probability*100).toFixed(1)}%`).join("<br>");
              if(res[0].className.match(/screen|error|bug/)){
                msg+="<br><b>â†’ ãƒã‚°ç”»é¢ã®ç–‘ã„ãŒã‚ã‚Šã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ´»ç”¨ã—ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã«åŸºã¥ãå¯¾å¿œãŒãŠã™ã™ã‚ã§ã™ã€‚</b>";
              }
            }else{
              msg += "èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
            }
            appendBubble(msg,"ai",imgHtml);
          };
        }else{
          appendBubble("AIãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™ã€‚æ•°ç§’å¾Œã«ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚","ai");
        }
      };
      reader.readAsDataURL(file);
    }else{
      appendBubble(`${file.name} (æœªå¯¾å¿œå½¢å¼) ã‚’å—ä¿¡ã—ã¾ã—ãŸã€‚å¯¾å¿œæ‹¡å¼µã‚’ã”å¸Œæœ›ã®å ´åˆã¯ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚`,"ai");
    }
  }

</script>
</body>
</html>
